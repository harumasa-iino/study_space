# トピック
AWSでインフラ構築をしてみる

## 目標
AWSでインフラ構築をする

### 課題に対しての学習内容

#### AWSのアカウント作成
- AWSアカウント作成  

※アカウント作成の際にクレジットカード情報が必要なので準備しておきましょう(デビットカードも可)！  
公式に丁寧な手順書があるので、これに従い作成してください！  
完了後は画面に従いAWSマネジメントコンソール画面(以下コンソール画面)を開き、次の項目(ルートアカウントの注意点)に進んでください！  
[AWS アカウント作成の流れ](https://aws.amazon.com/jp/register-flow/)

- ルートアカウントの注意点

アカウントを作成できたと思います！  
これでAWSのクラウドサービスを利用できますが、今ログインしているアカウントはルートアカウントというすべてのサービスの操作が可能であり、またアクセス権限を変更することができません。  
そのため通常はこのルートアカウントは保護し、利用するサービスへの制限を定義したユーザーを作成してそのユーザーアカウントでAWSを利用していきます。  
そのためのサービスが次で作業するIAMになります。  

#### IAMユーザーの作成
- IAMグループ作成

コンソール画面の上部にある検索フォームからIAMを検索して、IAMの画面へ移動します。  
左メニュー内の「個のユーザーグループ」から「グループ作成」に進んでください。  
下記内容で作成してください。  

グループ名：任意のものでOK  
アクセス許可ポリシーをアタッチ：検索窓で「AdministratorAccess」を検索しチェック  
IAMユーザー作成  

上記と同じく、IAMのコンソール画面の左メニュー内の「ユーザー」から「ユーザーを追加」に進んでください。  
下記内容でユーザを作成します。  
ユーザ名：任意のものでOK  
AWS 認証情報タイプを選択：パスワード - AWSマネジメントコンソールへのアクセス  
コンソールのパスワード：カスタムパスワード、任意のパスワードを入力してください  
パスワードリセットが必要：チェックなし  
アクセス権限：先ほど作成したIAMグループにチェック  
タグの追加：なし  
作成が終わったら作成したIAMユーザーでコンソール画面にログインできるか確認してみましょう！  
この段階で「rootアカウント」「作成したIAMユーザーアカウント」の2つがあるかと思います。  
基本的にAWS上での作業はrootアカウントは利用せずに、新しく作成したIAMユーザーアカウントを利用して進めていきます。  

- budgets設定

※budgets設定はAWSの権限上、rootアカウントを利用して進めます。  
AWSは無料枠で利用できるクラウドサービスもありますが、基本的には有料のサービスになっております。  
そのため意図しない課金が出ないように予算のアラート設定をしましょう。  
コンソール画面の検索窓から「budget」と検索して「AWS Budgets」のサービスを開き、「予算を作成」に進みます。  
下記の内容で作成していきます。  

予算タイプを選択  
予算タイプ：コスト予算  
予算名：任意の名前  
予算額を設定(ここは任意のものでも大丈夫です)  
間隔：月別  
予算有効日：定期予算  
開始月：現在の年月  
予算設定方法：固定  
予算額：10.00  
予算のスコープ：すべてデフォルト設定でokです  
閾値：任意の%  
トリガー：実績
Eメールの受信者：受信するメールアドレス  
アクションのアタッチ  
そのまま  

#### インフラの構築
- クラウドサーバーを構築する、地域(リージョン)を指定
AWSは全世界で利用されており、各地域でホスティングされています。  
画面右上のアカウント名の隣のプルダウンから「東京」を選んでください。  

用語  
ホスティング  
サーバーを借りること、ここではサーバーを利用されている(借りられている)という意味になります  

VPC  
VPC(Virtual Private Cloud)とは、AWS上に作成できるプライベートなネットワークの領域です。 
初期段階で各リージョンごとでデフォルトのVPCなどが設定されていますので、今回はそちらを利用していきます。  
コンソール画面の検索窓から「VPC」を検索し進んでください。  
「VPCダッシュボード」から確認してみましょう。  

それぞれNameタグが空になっているので、把握できるよう命名しておきましょう！  

VPC  
runteq-vpc  

サブネット  
runteq-subnet-1a  
runteq-subnet-1c  
※アベイラビリティゾーンごとで命名しています  

インターネットゲートウェイ  
runteq-igw  

ルートテーブル  
runteq-rt  

用語  
アベリラビリティゾーン(AZ)  
これはサーバーを物理的に置いているデータセンターについて、各リージョンで地域毎にデータセンターを分けた集合の単位のこと  

- ルートテーブルをサブネットに紐付け  
デフォルトで設定されているルートテーブル(runteq-rt)をプライベートサブネット（runteq-subnet-1a, runteq-subnet-1c）と紐づけます。  
紐付けたいルートテーブルを選択し、「サブネットの関連付けを編集」から下記の2つのサブネットで紐付けます。  

runteq-subnet-1a  
runteq-subnet-1c  

- セキュリティグループの作成

VPC内の通信の許可/拒否の設定をするためにセキュリティグループを設定することができます。  
今回はアプリケーションサーバーとデータベースの通信設定を作成していきましょう！  

手順
コンソール画面の検索窓から「VPC」を検索し進んでください。  
左メニューの「セキュリティグループ」を選択し、右上「セキュリティグループを作成」をクリックします。  
下記の設定で2つ作成します。  

アプリサーバー接続用  
基本的な詳細  
セキュリティグループ名：web-sg  
説明：web-sg  
VPC：runteq-vpc  
インバウンドルール(2つ)  
1つ目  
タイプ：HTTP  
リソースタイプ(画面によってはタイプ)：Anywhere-IPv4  

2つ目  
タイプ：ssh  
リソースタイプ(画面によってはタイプ)：Anywhere-IPv4  
アウトバウンドルール：そのまま  
タグ：なしでok  
※今回はクラウドサービスでアプリを動かすこと目的なので、HTTPのみの設定になっております  

データベース接続用  
基本的な詳細  
セキュリティグループ名：db-sg  
説明：db-sg  
VPC：runteq-vpc  
インバウンドルール  
タイプ：MYSQL/Aurora  
ソース：カスタム web-sg(先ほど作成したセキュリティグループ)  
アウトバウンドルール：そのまま  
タグ：なしでok  
データベースはアプリサーバーからのアクセスのみ許可したいので、インバウンドルールはweb-sgのグループIDを指定します  

AWSにおけるネットワーク構築については以上となります。  
次はRDSとEC2インスタンスの作成に移ります。  

#### EC2(Elastic Compute Cloud)
EC2はクラウドでサーバーの構築や運用ができるサービスです。  
アプリを動かすサーバーを作っていきましょう！  
コンソール画面の検索から「EC2」を検索してEC2の画面へ進み、左メニュー内の「インスタンス」を選択してください。  
右上の「インスタンスを起動」をクリックし、下記に従い設定していきます！  

Amazonマシンイメージ(AMI)  
Amazon Linux 2 AMI (HVM) - Kernel 5.10, SSD Volume Type(64ビット x86)  
インスタンスタイプの選択  
t2.micro  
インスタンスの詳細の設定  
インスタンス数：1  
ネットワーク：runteq-vpc  
サブネット：runteq-subnet-1a  
ストレージの追加：デフォルト  
タグの追加  
キー：Name  
値：runteq-web  
セキュリティグループの設定  
セキュリティグループの割り当て：既存  
セキュリティグループID：web-sg  
最後に「起動」をクリックすると、キーペアの作成が出るので、下記の設定でキーペアを作成してダウンロードをしてください。  
こちらはEC2にログインする際に必要なので、自分のPCに保存して、外部に出さないようにしましょう！  

新しいキーペアの作成  
キーペアのタイプ：RSA  
キーペア名：runteq-key  

- EC2にログイン
EC2へログインするために、ダウンロードしたキーペアを移動させます。  
ダウンロードしたrunteq-key.pemを~/.sshに移動させてください。  
移動完了後は、キーへのアクセス権限を設定します。キーがある階層に移動し、下記のコマンドを打ってください。  
`$ chmod 400 runteq-key.pem`

最後にsshログインのコマンドを取得します。  
EC2のコンソール画面で作成したインスタンスを選択し、「接続」をクリックします。  
「SSHクライアント」タブをクリックすると、接続のコマンドが出てきますので、ターミナルからそのコマンドを入力します。  

ターミナルで下記のようになればok

[ec2-user@... ~]$

- ElasticIP紐づける
先ほど作成したEC2は停止して再度起動すると、パブリックIPが変わり、毎回sshログイン時は不便になるので、固定のIPを紐付けます。  
EC2のダッシュボードの左メニューから「Elastic IP」に進み、右上の「Elastic IPアドレスの割り当て」から下記の設定で作成していきます。  

ネットワークボーダーグループ：ap-northeast-1a  
パブリックIPのアドレスプール：AmazonのIPv4アドレスプール  
作成後、今のElasticIPをEC2インスタンスに割り当てます。  
右上の「アクション」から「ElasticIPアドレスの関連付け」に進み、先ほど作成したEC2インスタンスに紐付け設定をしてください。  
作成したEC2の概要内にElasticIPアドレスが表示されていればokです！  

#### RDS(Relational Database Service)
RDSはクラウドでリレーショナルデータベースを利用できるサービスです。  
早速作成してきましょう！  

- DBサブネットグループの作成
コンソール画面の検索窓から「RDS」を検索し進んでください。  
まずはDB用のサブネットグループを作成します。  
左メニューの「サブネットグループ」を選択し、右上「DBサブネットグループを作成」をクリックします。  
下記の設定で作成します。  

サブネットグループの詳細  
名前：runteq-subnetgroup  
説明：runteq-subnetgroup  
VPC：runteq-vpc  
サブネットの追加  
アベイラビリティゾーン：ap-northeast-1a, ap-northeast-1c  
サブネット：runteq-subnet-1a, runteq-subnet-1c  

- RDSインスタンスの作成
コンソール画面の検索窓から「RDS」を検索し進んでください。  
左メニューの「データベース」を選択し、右上「データベースを作成」をクリックします。  
下記の設定で作成します。  

データベースの作成方法：標準作成  
エンジンのオプション  
エンジンのタイプ：MYSQL  
エディション：MySQL Community  
バージョン：5.7.xx(最新版)  
テンプレート：無料利用枠  
設定  
DBインスタンス識別子：デフォルト(database-1)  
マスターユーザー名：デフォルト(admin)  
マスターパスワード：任意のもの  
※ここでのユーザ名、パスワードは後ほどアプリ側に設定するので、控えておいてください。  
DBインスタンスクラス：デフォルト  
ストレージ：すべてデフォルト  
可用性と耐久性：デフォルト  
接続  
VPC：runteq-vpc  
サブネットグループ：runteq-subnetgroup  
パブリックアクセス：なし  
VPCセキュリティグループ：既存の選択 db-sg  
アベイラビリティゾーン：ap-northeast-1a  
データベースポート：3306  
データベース認証：パスワード認証  
追加設定  
最初のデータベース名：runteq_db  
その他はそのままでok  


## 参考サイト
- [参考サイト1](https://www.google.com/?hl=ja)
- [参考サイト2](https://www.google.com/?hl=ja)
- [参考サイト3](https://www.google.com/?hl=ja)